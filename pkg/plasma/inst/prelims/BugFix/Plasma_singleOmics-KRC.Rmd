---
title: "Compare weighted to unweighted averages"
author: "Kyoko Yamaguchi"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: yeti
    highlight: kate
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document attemts to 1) calculate some reasonable vector of weights for multiplication during the "extention" portion of the plasma function and 2) compare the root mean squared error (RMSE) between the truth and predictions using the unweighted averages and the weighted averages to see if the weights actually make a difference.


# This is a document to compare weighted to unweighted averages

```{r packages}
library(dplyr)
library(pls)
library(plsRcox)
library(survival)
library(plasma)
```

Load data and libraries

```{r escadata}
# load("C:/Users/Owner/Desktop/svn_oompa_dev/prePlasma/TCGA-ESCA-full.RData")
plasma::loadESCAdata()
```

```{r peek}
suspects <- c("A4OM", "A49V", "A8NI")
Outcome[suspects,] # nothing special
sapply(assemble, function(X) (suspects %in% colnames(X)))
sapply(assemble, function(X) {
  S <- suspects[suspects %in% colnames(X)]
  apply(X[, S, drop = FALSE], 2, summary)
})
ls()
```
We have minor missing data in the ClinicalBin data set for two suspect samples (A4OM, A49V).
We also have completely missing data in some of the omics data sets. Other than that, things
look fine.

# Proof of concept for one iteration only
## Dataset shrinking
What if we shrink to some percentage of its original size?
Output the names of the datasets that are going to be shrunken:
```{r namesub}
set.seed(123)
namesub<- c("MAF", "Meth450", "miRSeq", "mRNASeq")
```


```{r truth}
assemble_truth <- assemble[ which(names(assemble) %in% namesub) ]
```


assemble_truth contains the original unmodified data. The model arising from assemble represents our "ground truth" model.

```{r truthdim}
lapply(assemble_truth, dim)
```
ith these selected datasets and the unweighted averages
### Make the true model (with the full data)

```{r MOtruth}
MO_truth <- prepareMultiOmics(assemble_truth, Outcome)
suppressWarnings( firstPass_truth <- fitCoxModels(MO_truth, timevar = "Days",
                          eventvar = "vital_status", eventvalue = "dead") )
plot(firstPass_truth)
```

```{r peektruth}
lapply(namesub, function(ds) {
  A <- firstPass_truth@models[[ds]]
  A@Xout[suspects,]
})
```
When we look into the single-omic models, we see the expected results. Specifically, 
we get reasonable values when the sample is in the omics data set, and get NA's otherwise.
**WAIT!** Shouldn't it be the case that all the names are present in all the data sets?
```{r closerlook}
sapply(namesub, function(ds) {
  A <- firstPass_truth@models[[ds]]
  dim(A@Xout)
})
```
Never mind; these do not get automatically expanded to the full sample set. So, everything
is as it should be so far.

```{r pltruth}
pl_truth <- plasma(MO_truth, firstPass_truth)
# plot(pl_truth, legloc = "topright", main = "True Data")
```

```{r followuptruth}
mp <- pl_truth@meanPredictions
mp[suspects,]
```
One of the "suspects" produces NaN's across the board. Let's see if we can figure out
where that comes from.
```{r whyna}
modlist <- pl_truth@compModels
for (N in names(modlist)) {
  print(N)
  X <- modlist[[N]]
  Y <- X$allPred
  S <- suspects[suspects %in% rownames(Y)]
  print(Y[S, , drop = FALSE], 2)
}
```
Well, it seems that we have no data for suspect `A8NI`. That makes it hard to pool
the prediction data. But why do we get NA's from the MAF and Meth450 data sets, even though
we know most of the data is available there?
```{r mafbad}
A <- modlist$MAF$allPred
awful <- apply(A, 1, function(x) all(is.na(x)))

pick <- apply(assemble$MAF, 2, function(x) any(is.na(x)))
all(names(pick) == names(awful))
summary(awful)
awful <- awful[names(pick)]
table(awful, pick)
```

```{r gar}
AMAF <- assemble$MAF
amed <- apply(AMAF, 1, median, na.rm = TRUE)
summary(amed)
for (i in 1:nrow(AMAF)) {
  X <- AMAF[i,]
  X[is.na(X)] <- amed[i]
  AMAF[i,] <- X
}
any(is.na(AMAF))
```

```{r gle}
AMeth <- assemble$Meth450
amed <- apply(AMeth, 1, median, na.rm = TRUE)
summary(amed)
for (i in 1:nrow(AMeth)) {
  X <- AMeth[i,]
  X[is.na(X)] <- amed[i]
  AMeth[i,] <- X
}
any(is.na(AMeth))
```

```{r imputed}
imputed <- assemble[which(names(assemble) %in% namesub) ]
imputed$MAF <- AMAF
imputed$Meth450 <- AMeth

MO_imp <- prepareMultiOmics(imputed, Outcome)
suppressWarnings( firstPass_imp <- fitCoxModels(MO_imp, timevar = "Days",
                          eventvar = "vital_status", eventvalue = "dead") )
plot(firstPass_imp)

pl_imp <- plasma(MO_imp, firstPass_imp)
plot(pl_imp)
mp <- pl_imp@meanPredictions
mp[suspects,]
```


